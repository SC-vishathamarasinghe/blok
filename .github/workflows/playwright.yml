name: Playwright Tests

on:
  # Run on push (commits) to these branches
  push:
    branches: 
      - main
      - dev
      - QA-Automation
      - QA-Automation_NextFW
  
  # Run when PR is opened, updated, or reopened targeting these branches
  pull_request:
    branches: 
      - main
      - dev
      - QA-Automation
      - QA-Automation_NextFW
    types: [ opened, synchronize, reopened ]
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    # Step 1: Checkout QA-Automation_NextFW branch (Next.js app)
    - name: Checkout Next.js app (QA-Automation_NextFW)
      uses: actions/checkout@v4
      with:
        ref: QA-Automation_NextFW
        path: app
    
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    # Step 3: Install app dependencies
    - name: Install app dependencies
      working-directory: ./app
      run: npm ci
    
    # Step 4: Install components from components-config.json
    - name: Install Blok components
      working-directory: ./app
      run: |
        echo "üì¶ Installing components from configuration..."
        
        # Check if components-config.json exists, if not use default
        if [ -f "components-config.json" ]; then
          echo "‚úÖ Found components-config.json, reading configuration..."
          
          # Install bulk components if enabled
          BULK_ENABLED=$(node -p "require('./components-config.json').bulkInstall?.enabled !== false")
          if [ "$BULK_ENABLED" = "true" ]; then
            BULK_URL=$(node -p "require('./components-config.json').bulkInstall?.url || ''")
            if [ -n "$BULK_URL" ] && [ "$BULK_URL" != "undefined" ]; then
              echo "üì• Installing bulk components from: $BULK_URL"
              npx shadcn@latest add "$BULK_URL" --yes || true
            fi
          fi
          
          # Install additional components
          echo "üì• Installing additional components..."
          node -e "
            const config = require('./components-config.json');
            if (config.additionalComponents && Array.isArray(config.additionalComponents)) {
              config.additionalComponents.forEach(url => {
                if (typeof url === 'string' && url.trim()) {
                  console.log(url);
                }
              });
            }
          " | while IFS= read -r componentUrl; do
            if [ -n "$componentUrl" ]; then
              echo "  ‚Üí Installing from: $componentUrl"
              npx shadcn@latest add "$componentUrl" --yes 2>&1 || echo "    ‚ö†Ô∏è Component installation skipped (may already exist or not available)"
            fi
          done
        else
          echo "‚ö†Ô∏è components-config.json not found, using default URL..."
          npx shadcn@latest add https://blok.sitecore.com/r/blok-components.json --yes || true
        fi
        
        echo "‚úÖ Component installation completed"
    
    # Step 5: Build Next.js application
    - name: Build Next.js application
      working-directory: ./app
      run: npm run build
      env:
        NODE_ENV: production
    
    # Step 6: Start Next.js server in background
    - name: Start Next.js server
      working-directory: ./app
      run: |
        npm start > server.log 2>&1 &
        echo $! > server.pid
        echo "Server starting with PID: $(cat server.pid)"
      env:
        NODE_ENV: production
        PORT: 3000
    
    # Step 7: Wait for server to be ready
    - name: Wait for server to be ready
      run: |
        echo "Waiting for Next.js server to start..."
        timeout=120
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
            echo "‚úÖ Server is ready and responding!"
            curl -s http://localhost:3000 | head -n 5
            exit 0
          fi
          echo "‚è≥ Waiting for server... ($elapsed/$timeout seconds)"
          sleep 3
          elapsed=$((elapsed + 3))
        done
        echo "‚ùå Server failed to start within $timeout seconds"
        echo "Server log:"
        cat app/server.log || true
        exit 1
    
    # Step 8: Checkout QA-Automation branch (tests)
    - name: Checkout tests (QA-Automation)
      uses: actions/checkout@v4
      with:
        ref: QA-Automation
        path: tests
    
    # Step 9: Install test dependencies
    - name: Install test dependencies
      working-directory: ./tests
      run: npm ci
    
    # Step 10: Install Playwright Browsers
    - name: Install Playwright Browsers
      working-directory: ./tests
      run: npx playwright install --with-deps
    
    # Step 11: Run Playwright tests against localhost
    - name: Run Playwright tests
      id: run-tests
      working-directory: ./tests
      continue-on-error: true
      run: |
        set +e
        # Run tests with both JSON and HTML reporters
        # JSON reporter outputs to stdout, so we capture it to a file
        # HTML reporter creates playwright-report/ directory
        npx playwright test --reporter=json,html > test-results.json 2>&1
        TEST_EXIT_CODE=$?
        echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
        
        # Extract JSON from the output (it might be mixed with other output)
        # Try to find the JSON object in the file
        if [ -f test-results.json ]; then
          # Extract just the JSON part (from first { to last })
          # Playwright JSON output is typically the last JSON object in the output
          grep -o '{.*}' test-results.json | tail -1 > test-results-clean.json 2>/dev/null || true
          if [ -f test-results-clean.json ] && [ -s test-results-clean.json ]; then
            mv test-results-clean.json test-results.json
          fi
        fi
        
        # Don't exit with error code here - let continue-on-error handle it
        # This allows parsing step to run even if tests fail
        exit 0
      env:
        BASE_URL: http://localhost:3000
    
    # Step 11.5: Parse test results
    - name: Parse test results
      id: test-results
      if: always()
      working-directory: ./tests
      run: |
        # Create script to parse Playwright JSON results
        cat > parse-results.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        let total = 0, passed = 0, failed = 0, skipped = 0;
        let status = 'unknown';
        const exitCode = process.env.EXIT_CODE || '0';
        
        try {
          // Try multiple possible locations for JSON results file
          const possiblePaths = [
            path.join(__dirname, 'test-results.json'),
            path.join(__dirname, 'playwright-report', 'data', 'test-results.json'),
            path.join(process.cwd(), 'test-results.json'),
            path.join(process.cwd(), 'playwright-report', 'data', 'test-results.json'),
            path.join(process.cwd(), 'playwright-report', 'data.json')
          ];
          
          let jsonData = null;
          for (const jsonPath of possiblePaths) {
            if (fs.existsSync(jsonPath)) {
              try {
                jsonData = JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));
                console.error(`Found JSON results at: ${jsonPath}`);
                break;
              } catch (e) {
                console.error(`Error reading ${jsonPath}:`, e.message);
              }
            }
          }
          
          if (jsonData) {
            // Playwright JSON format has suites array
            if (jsonData.suites && Array.isArray(jsonData.suites)) {
              const countTests = (suite) => {
                if (suite.specs) {
                  suite.specs.forEach(spec => {
                    if (spec.tests) {
                      spec.tests.forEach(test => {
                        total++;
                        if (test.results && test.results.length > 0) {
                          const result = test.results[test.results.length - 1];
                          if (result.status === 'passed') passed++;
                          else if (result.status === 'failed') failed++;
                          else if (result.status === 'skipped') skipped++;
                        }
                      });
                    }
                  });
                }
                if (suite.suites) {
                  suite.suites.forEach(countTests);
                }
              };
              jsonData.suites.forEach(countTests);
            }
            
            // Determine status
            if (failed > 0) {
              status = 'failed';
            } else if (passed > 0 && failed === 0) {
              status = 'passed';
            } else {
              status = 'unknown';
            }
          } else {
            // Fallback: use exit code if JSON file doesn't exist
            console.error('JSON results file not found in any location, using exit code');
            if (exitCode !== '0') {
              status = 'failed';
            } else {
              status = 'passed';
            }
          }
        } catch (e) {
          console.error('Error parsing results:', e.message);
          // Fallback to exit code
          if (exitCode !== '0') {
            status = 'failed';
          } else {
            status = 'passed';
          }
        }
        
        // Output for GitHub Actions (format: key=value)
        console.log(`total=${total}`);
        console.log(`passed=${passed}`);
        console.log(`failed=${failed}`);
        console.log(`skipped=${skipped}`);
        console.log(`status=${status}`);
        
        // Also output to console for debugging
        console.error(`Test Results: Total=${total}, Passed=${passed}, Failed=${failed}, Skipped=${skipped}, Status=${status}`);
        EOF
        
        EXIT_CODE="${{ steps.run-tests.outputs.exit_code || '0' }}" node parse-results.js >> $GITHUB_OUTPUT
    
    # Step 11.6: Get commit/PR author information
    - name: Get author information
      id: author-info
      if: always()
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # For Pull Requests
          AUTHOR_USERNAME="${{ github.event.pull_request.user.login }}"
          AUTHOR_NAME="${{ github.event.pull_request.user.name || github.event.pull_request.user.login }}"
        else
          # For direct commits/pushes
          AUTHOR_USERNAME="${{ github.actor }}"
          AUTHOR_NAME="${{ github.event.head_commit.author.name || github.actor }}"
        fi
        
        echo "username=$AUTHOR_USERNAME" >> $GITHUB_OUTPUT
        echo "name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
    
    # Step 11.7: Generate workflow summary
    - name: Generate workflow summary
      if: always()
      run: |
        STATUS="${{ steps.test-results.outputs.status }}"
        TOTAL="${{ steps.test-results.outputs.total }}"
        PASSED="${{ steps.test-results.outputs.passed }}"
        FAILED="${{ steps.test-results.outputs.failed }}"
        SKIPPED="${{ steps.test-results.outputs.skipped }}"
        
        # Set defaults if empty
        STATUS="${STATUS:-unknown}"
        TOTAL="${TOTAL:-0}"
        PASSED="${PASSED:-0}"
        FAILED="${FAILED:-0}"
        SKIPPED="${SKIPPED:-0}"
        
        # Determine emoji and text based on status
        if [ "$STATUS" == "failed" ]; then
          STATUS_EMOJI="‚ùå"
          STATUS_TEXT="Failed"
        elif [ "$STATUS" == "passed" ]; then
          STATUS_EMOJI="‚úÖ"
          STATUS_TEXT="Passed"
        else
          STATUS_EMOJI="‚ö†Ô∏è"
          STATUS_TEXT="Unknown"
        fi
        
        WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        REPORT_URL="${WORKFLOW_RUN_URL}#artifacts"
        
        echo "## üß™ Playwright Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ${STATUS_EMOJI} Test Status: ${STATUS_TEXT}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Test Metrics" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
        echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Tests** | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚úÖ **Passed** | ${PASSED} |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚ùå **Failed** | ${FAILED} |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚è≠Ô∏è **Skipped** | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîç Test Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ steps.author-info.outputs.name }} (@${{ steps.author-info.outputs.username }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: [${{ github.workflow }}](${WORKFLOW_RUN_URL})" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìÑ Test Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Playwright Report**: [View Report](${REPORT_URL})" >> $GITHUB_STEP_SUMMARY
        echo "  - Download the \`playwright-report\` artifact to view the full HTML report" >> $GITHUB_STEP_SUMMARY
        echo "  - Open \`index.html\` in a browser after downloading" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$STATUS" == "failed" ]; then
          echo "### ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
          echo "Some tests have failed. Please review the test results and fix the issues." >> $GITHUB_STEP_SUMMARY
        elif [ "$STATUS" == "passed" ]; then
          echo "### ‚úÖ All Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "All Playwright tests completed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ö†Ô∏è Status Unknown" >> $GITHUB_STEP_SUMMARY
          echo "Unable to parse test results. Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi
    
    # Step 11.8: Output test status notices
    - name: Output test status notices
      if: always()
      run: |
        STATUS="${{ steps.test-results.outputs.status }}"
        TOTAL="${{ steps.test-results.outputs.total }}"
        PASSED="${{ steps.test-results.outputs.passed }}"
        FAILED="${{ steps.test-results.outputs.failed }}"
        SKIPPED="${{ steps.test-results.outputs.skipped }}"
        
        # Set defaults if empty
        STATUS="${STATUS:-unknown}"
        TOTAL="${TOTAL:-0}"
        PASSED="${PASSED:-0}"
        FAILED="${FAILED:-0}"
        SKIPPED="${SKIPPED:-0}"
        
        if [ "$STATUS" == "failed" ]; then
          echo "::error title=‚ùå Tests Failed::Playwright tests failed. Total: ${TOTAL}, Passed: ${PASSED}, Failed: ${FAILED}, Skipped: ${SKIPPED}"
          echo "::notice title=üìä Test Results::Total: ${TOTAL} | Passed: ${PASSED} | Failed: ${FAILED} | Skipped: ${SKIPPED}"
        elif [ "$STATUS" == "passed" ]; then
          echo "::notice title=‚úÖ Tests Passed::All Playwright tests passed successfully. Total: ${TOTAL}, Passed: ${PASSED}, Skipped: ${SKIPPED}"
        else
          echo "::warning title=‚ö†Ô∏è Test Status Unknown::Unable to parse test results. Total: ${TOTAL}, Passed: ${PASSED}, Failed: ${FAILED}, Skipped: ${SKIPPED}"
        fi
        
        echo "::notice title=üìÑ Test Report::Download the 'playwright-report' artifact to view the full HTML test report"
    
    # Step 12: Cleanup - Stop the server
    - name: Stop Next.js server
      if: always()
      working-directory: ./app
      run: |
        echo "Stopping Next.js server..."
        if [ -f server.pid ]; then
          PID=$(cat server.pid)
          echo "Killing process $PID"
          kill $PID 2>/dev/null || true
          rm server.pid
        fi
        # Also kill any remaining node processes
        pkill -f "next start" || true
        pkill -f "node.*next" || true
        echo "Server stopped"
    
    # Step 13: Upload test results
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: tests/playwright-report/
        retention-days: 30
      continue-on-error: true
    
    # Step 14: Upload server logs for debugging (if tests fail)
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: server-logs
        path: app/server.log
        retention-days: 7
      continue-on-error: true
    
    # Step 15: Comment on PR with test results (triggers GitHub email notifications)
    - name: Comment on PR with test results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const status = '${{ steps.test-results.outputs.status }}' || 'unknown';
          const total = '${{ steps.test-results.outputs.total }}' || '0';
          const passed = '${{ steps.test-results.outputs.passed }}' || '0';
          const failed = '${{ steps.test-results.outputs.failed }}' || '0';
          const skipped = '${{ steps.test-results.outputs.skipped }}' || '0';
          const author = '@${{ steps.author-info.outputs.username }}' || '@${{ github.actor }}';
          const workflowRunUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          const prUrl = `${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}`;
          const reportUrl = `${workflowRunUrl}#artifacts`;
          
          // Get specific person's GitHub username from secret, or use email-based lookup
          let specificPerson = '';
          const notificationUsername = '${{ secrets.NOTIFICATION_USERNAME }}';
          
          if (notificationUsername) {
            specificPerson = `@${notificationUsername}`;
          } else {
            // Try to find user by email vishath.amarasinghe@sitecore.com
            try {
              const searchResult = await github.rest.search.users({
                q: 'vishath.amarasinghe@sitecore.com in:email'
              });
              if (searchResult.data.items.length > 0) {
                specificPerson = `@${searchResult.data.items[0].login}`;
              }
            } catch (e) {
              // If search fails, mention email in comment
              specificPerson = 'vishath.amarasinghe@sitecore.com';
            }
          }
          
          // Determine status emoji and text
          let statusEmoji, statusText;
          if (status === 'failed') {
            statusEmoji = '‚ùå';
            statusText = 'Failed';
          } else if (status === 'passed') {
            statusEmoji = '‚úÖ';
            statusText = 'Passed';
          } else {
            statusEmoji = '‚ö†Ô∏è';
            statusText = 'Unknown';
          }
          
          // Build mentions
          const mentions = specificPerson ? `${author} ${specificPerson}` : author;
          
          // Build comment with markdown
          const comment = `## ${statusEmoji} Playwright Test Results
          
          ${mentions}
          
          **Status:** ${statusText} | **Workflow:** [${{ github.workflow }}](${workflowRunUrl})
          
          | Metric | Count |
          |--------|-------|
          | **Total Tests** | ${total} |
          | ‚úÖ **Passed** | ${passed} |
          | ‚ùå **Failed** | ${failed} |
          | ‚è≠Ô∏è **Skipped** | ${skipped} |
          
          ### Details
          - **Repository:** \`${{ github.repository }}\`
          - **Branch:** \`${{ github.ref_name }}\`
          - **Commit:** \`${{ github.sha }}\`
          - **Author:** ${author}
          - **Workflow Run:** [View Details](${workflowRunUrl})
          - **Pull Request:** [View PR](${prUrl})
          
          ### üìÑ Test Report
          - **Playwright Report:** [Download Report](${reportUrl})
            - Download the \`playwright-report\` artifact from the workflow run
            - Extract and open \`index.html\` in a browser to view the full HTML report
            - The report includes detailed test results, screenshots, and traces
          
          ${status === 'failed' || parseInt(failed) > 0 ? '‚ö†Ô∏è **Some tests failed. Please review the test results and download the report for details.**' : status === 'passed' ? '‚úÖ **All tests passed successfully!**' : '‚ö†Ô∏è **Unable to parse test results. Please check the workflow logs for details.**'}
          
          ---
          *This is an automated notification from GitHub Actions. Email notifications are sent to mentioned users.*`;
          
          // Create comment on PR
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.error('Error creating PR comment:', error.message);
          }
    
    # Step 16: Log test results for direct commits
    # Note: GitHub automatically sends email notifications to commit authors when workflow completes
    # For vishath.amarasinghe@sitecore.com to receive notifications, they should:
    # 1. Add their GitHub username to NOTIFICATION_USERNAME secret, OR
    # 2. Be added as a repository collaborator/watcher
    - name: Log test results for direct commits
      if: github.event_name != 'pull_request' && always()
      run: |
        STATUS="${{ steps.test-results.outputs.status }}"
        TOTAL="${{ steps.test-results.outputs.total }}"
        PASSED="${{ steps.test-results.outputs.passed }}"
        FAILED="${{ steps.test-results.outputs.failed }}"
        SKIPPED="${{ steps.test-results.outputs.skipped }}"
        
        # Set defaults if empty
        STATUS="${STATUS:-unknown}"
        TOTAL="${TOTAL:-0}"
        PASSED="${PASSED:-0}"
        FAILED="${FAILED:-0}"
        SKIPPED="${SKIPPED:-0}"
        
        echo "## Test Results Summary"
        echo "Status: ${STATUS}"
        echo "Total: ${TOTAL}"
        echo "Passed: ${PASSED}"
        echo "Failed: ${FAILED}"
        echo "Skipped: ${SKIPPED}"
        echo "Author: ${{ steps.author-info.outputs.name }} (@${{ steps.author-info.outputs.username }})"
        echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "Note: GitHub will automatically send email notifications to the commit author."
        echo "To notify vishath.amarasinghe@sitecore.com, add their GitHub username to NOTIFICATION_USERNAME secret."
