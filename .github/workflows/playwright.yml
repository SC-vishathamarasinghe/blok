name: Playwright Tests

on:
  # Run on push (commits) to these branches
  push:
    branches: 
      - main
      - dev
      - QA-Automation
      - QA-Automation_NextFW
  
  # Run when PR is opened, updated, or reopened targeting these branches
  pull_request:
    branches: 
      - main
      - dev
      - QA-Automation
      - QA-Automation_NextFW
    types: [ opened, synchronize, reopened ]
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    # Step 1: Checkout QA-Automation_NextFW branch (Next.js app)
    - name: Checkout Next.js app (QA-Automation_NextFW)
      uses: actions/checkout@v4
      with:
        ref: QA-Automation_NextFW
        path: app
    
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    # Step 3: Install app dependencies
    - name: Install app dependencies
      working-directory: ./app
      run: npm ci
    
    # Step 4: Build Next.js application
    - name: Build Next.js application
      working-directory: ./app
      run: npm run build
      env:
        NODE_ENV: production
    
    # Step 5: Start Next.js server in background
    - name: Start Next.js server
      working-directory: ./app
      run: |
        npm start > server.log 2>&1 &
        echo $! > server.pid
        echo "Server starting with PID: $(cat server.pid)"
      env:
        NODE_ENV: production
        PORT: 3000
    
    # Step 6: Wait for server to be ready
    - name: Wait for server to be ready
      run: |
        echo "Waiting for Next.js server to start..."
        timeout=120
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
            echo "✅ Server is ready and responding!"
            curl -s http://localhost:3000 | head -n 5
            exit 0
          fi
          echo "⏳ Waiting for server... ($elapsed/$timeout seconds)"
          sleep 3
          elapsed=$((elapsed + 3))
        done
        echo "❌ Server failed to start within $timeout seconds"
        echo "Server log:"
        cat app/server.log || true
        exit 1
    
    # Step 7: Checkout QA-Automation branch (tests)
    - name: Checkout tests (QA-Automation)
      uses: actions/checkout@v4
      with:
        ref: QA-Automation
        path: tests
    
    # Step 8: Install test dependencies
    - name: Install test dependencies
      working-directory: ./tests
      run: npm ci
    
    # Step 9: Install Playwright Browsers
    - name: Install Playwright Browsers
      working-directory: ./tests
      run: npx playwright install --with-deps
    
    # Step 10: Run Playwright tests against localhost
    - name: Run Playwright tests
      working-directory: ./tests
      run: npx playwright test
      env:
        BASE_URL: http://localhost:3000
    
    # Step 11: Cleanup - Stop the server
    - name: Stop Next.js server
      if: always()
      working-directory: ./app
      run: |
        echo "Stopping Next.js server..."
        if [ -f server.pid ]; then
          PID=$(cat server.pid)
          echo "Killing process $PID"
          kill $PID 2>/dev/null || true
          rm server.pid
        fi
        # Also kill any remaining node processes
        pkill -f "next start" || true
        pkill -f "node.*next" || true
        echo "Server stopped"
    
    # Step 12: Upload test results
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: tests/playwright-report/
        retention-days: 30
      continue-on-error: true
    
    # Step 13: Upload server logs for debugging (if tests fail)
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: server-logs
        path: app/server.log
        retention-days: 7
      continue-on-error: true
