name: Playwright Tests

on:
  # Run on push (commits) to these branches
  push:
    branches: 
      - main
      - dev
      - QA-Automation
      - QA-Automation_NextFW
  
  # Run when PR is opened, updated, or reopened targeting these branches
  pull_request:
    branches: 
      - main
      - dev
      - QA-Automation
      - QA-Automation_NextFW
    types: [ opened, synchronize, reopened ]
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    # Step 1: Checkout QA-Automation_NextFW branch (Next.js app)
    - name: Checkout Next.js app (QA-Automation_NextFW)
      uses: actions/checkout@v4
      with:
        ref: QA-Automation_NextFW
        path: app
    
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    # Step 3: Install app dependencies
    - name: Install app dependencies
      working-directory: ./app
      run: npm ci
    
    # Step 4: Install components from components-config.json
    - name: Install Blok components
      working-directory: ./app
      run: |
        echo "ðŸ“¦ Installing components from configuration..."
        
        # Check if components-config.json exists, if not use default
        if [ -f "components-config.json" ]; then
          echo "âœ… Found components-config.json, reading configuration..."
          
          # Install bulk components if enabled
          BULK_ENABLED=$(node -p "require('./components-config.json').bulkInstall?.enabled !== false")
          if [ "$BULK_ENABLED" = "true" ]; then
            BULK_URL=$(node -p "require('./components-config.json').bulkInstall?.url || ''")
            if [ -n "$BULK_URL" ] && [ "$BULK_URL" != "undefined" ]; then
              echo "ðŸ“¥ Installing bulk components from: $BULK_URL"
              npx shadcn@latest add "$BULK_URL" --yes || true
            fi
          fi
          
          # Install additional components
          echo "ðŸ“¥ Installing additional components..."
          node -e "
            const config = require('./components-config.json');
            if (config.additionalComponents && Array.isArray(config.additionalComponents)) {
              config.additionalComponents.forEach(url => {
                if (typeof url === 'string' && url.trim()) {
                  console.log(url);
                }
              });
            }
          " | while IFS= read -r componentUrl; do
            if [ -n "$componentUrl" ]; then
              echo "  â†’ Installing from: $componentUrl"
              npx shadcn@latest add "$componentUrl" --yes 2>&1 || echo "    âš ï¸ Component installation skipped (may already exist or not available)"
            fi
          done
        else
          echo "âš ï¸ components-config.json not found, using default URL..."
          npx shadcn@latest add https://blok.sitecore.com/r/blok-components.json --yes || true
        fi
        
        echo "âœ… Component installation completed"
    
    # Step 5: Build Next.js application
    - name: Build Next.js application
      working-directory: ./app
      run: npm run build
      env:
        NODE_ENV: production
    
    # Step 6: Start Next.js server in background
    - name: Start Next.js server
      working-directory: ./app
      run: |
        npm start > server.log 2>&1 &
        echo $! > server.pid
        echo "Server starting with PID: $(cat server.pid)"
      env:
        NODE_ENV: production
        PORT: 3000
    
    # Step 7: Wait for server to be ready
    - name: Wait for server to be ready
      run: |
        echo "Waiting for Next.js server to start..."
        timeout=120
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Server is ready and responding!"
            curl -s http://localhost:3000 | head -n 5
            exit 0
          fi
          echo "â³ Waiting for server... ($elapsed/$timeout seconds)"
          sleep 3
          elapsed=$((elapsed + 3))
        done
        echo "âŒ Server failed to start within $timeout seconds"
        echo "Server log:"
        cat app/server.log || true
        exit 1
    
    # Step 8: Checkout QA-Automation branch (tests)
    - name: Checkout tests (QA-Automation)
      uses: actions/checkout@v4
      with:
        ref: QA-Automation
        path: tests
    
    # Step 9: Install test dependencies
    - name: Install test dependencies
      working-directory: ./tests
      run: npm ci
    
    # Step 10: Install Playwright Browsers
    - name: Install Playwright Browsers
      working-directory: ./tests
      run: npx playwright install --with-deps
    
    # Step 11: Run Playwright tests against localhost
    - name: Run Playwright tests
      working-directory: ./tests
      run: npx playwright test
      env:
        BASE_URL: http://localhost:3000
    
    # Step 12: Cleanup - Stop the server
    - name: Stop Next.js server
      if: always()
      working-directory: ./app
      run: |
        echo "Stopping Next.js server..."
        if [ -f server.pid ]; then
          PID=$(cat server.pid)
          echo "Killing process $PID"
          kill $PID 2>/dev/null || true
          rm server.pid
        fi
        # Also kill any remaining node processes
        pkill -f "next start" || true
        pkill -f "node.*next" || true
        echo "Server stopped"
    
    # Step 13: Upload test results
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: tests/playwright-report/
        retention-days: 30
      continue-on-error: true
    
    # Step 14: Upload server logs for debugging (if tests fail)
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: server-logs
        path: app/server.log
        retention-days: 7
      continue-on-error: true
